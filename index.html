<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–£—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:20px; }
h1 { color:#333; text-align:center; }
.panel { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.2); margin-bottom:20px; }
.panel p { margin:8px 0; font-size:16px; }
.status { font-weight:bold; font-size:18px; }
.counter { font-size:18px; }
button { padding:8px 12px; margin:5px; border:none; border-radius:5px; cursor:pointer; }
.btn { background:#4CAF50; color:white; }
.btn-red { background:#f44336; color:white; }
.btn-blue { background:#2196F3; color:white; }
.hidden { display:none; }
#tripList { list-style:none; padding-left:0; }
#tripList li { background:#fff; margin-bottom:5px; padding:8px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.form-group { margin-bottom:10px; }
input { padding:5px; width:100%; box-sizing:border-box; margin-top:3px; }
</style>
</head>
<body>

<h1>–£—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</h1>

<div class="panel">
    <p>–ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏: <span id="zoneCoords">–Ω–µ –∑–∞–¥–∞–Ω–æ</span></p>
    <p>–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä: <span id="excCoords">–Ω–µ –∑–∞–¥–∞–Ω–æ</span></p>
    <p>–¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span id="coords">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></p>
    <p>–°—Ç–∞—Ç—É—Å: <span id="status" class="status">–û–∂–∏–¥–∞–Ω–∏–µ...</span></p>
    <p>–°—á—ë—Ç—á–∏–∫ —Ä–µ–π—Å–æ–≤: <span id="counter" class="counter">0</span></p>
</div>

<button class="btn" onclick="toggleForm()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–æ–Ω</button>

<div id="formContainer" class="panel hidden">
    <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã –≤—ã–≥—Ä—É–∑–∫–∏:</label>
        <input type="text" id="zoneName">
        <label>–®–∏—Ä–æ—Ç–∞:</label>
        <input type="number" id="zoneLat" step="0.000001">
        <label>–î–æ–ª–≥–æ—Ç–∞:</label>
        <input type="number" id="zoneLon" step="0.000001">
        <button class="btn" onclick="saveZone()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
        <button class="btn" onclick="setZone()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
    </div>
    <hr>
    <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞:</label>
        <input type="text" id="excName">
        <label>–®–∏—Ä–æ—Ç–∞:</label>
        <input type="number" id="excLat" step="0.000001">
        <label>–î–æ–ª–≥–æ—Ç–∞:</label>
        <input type="number" id="excLon" step="0.000001">
        <button class="btn" onclick="saveExc()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
        <button class="btn" onclick="setExc()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
    </div>
</div>

<div id="notify" class="panel hidden"></div>

<h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–π—Å–æ–≤:</h3>
<ul id="tripList"></ul>
<button class="btn-blue" onclick="downloadData()">‚¨áÔ∏è –í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>

<script>
let data = {
    zone:null,
    excavator:null,
    trips:0,
    tripData:[],
    currentTrip:null,
    currentLat:null,
    currentLon:null,
    currentStatus:"–û–∂–∏–¥–∞–Ω–∏–µ..."
};

const positionHistory = [];
const MAX_HISTORY = 5;

function notify(msg){
    const n = document.getElementById('notify');
    n.innerText = msg;
    n.classList.remove('hidden');
    setTimeout(()=>n.classList.add('hidden'),3000);
}

function saveData(){ localStorage.setItem('pgsData', JSON.stringify(data)); }
function loadData(){ 
    const saved = localStorage.getItem('pgsData');
    if(saved){ data=JSON.parse(saved); updateUI(); }
}

function toggleForm(){ document.getElementById('formContainer').classList.toggle('hidden'); }

function updateUI(){
    document.getElementById('counter').innerText = data.trips;
    document.getElementById('status').innerText = data.currentStatus;
    document.getElementById('coords').innerText = data.currentLat ? `${data.currentLat.toFixed(6)}, ${data.currentLon.toFixed(6)}` : "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
    document.getElementById('zoneCoords').innerText = data.zone ? `${data.zone.lat.toFixed(6)}, ${data.zone.lon.toFixed(6)}` : "–Ω–µ –∑–∞–¥–∞–Ω–æ";
    document.getElementById('excCoords').innerText = data.excavator ? `${data.excavator.lat.toFixed(6)}, ${data.excavator.lon.toFixed(6)}` : "–Ω–µ –∑–∞–¥–∞–Ω–æ";
    renderTripList();
}

function setZone(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            data.zone = { lat: pos.coords.latitude, lon: pos.coords.longitude, name:document.getElementById('zoneName').value || "–ó–æ–Ω–∞"};
            saveData();
            updateUI();
            notify("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–æ–Ω—ã –≤—ã–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        });
    } else { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); }
}

function saveZone(){
    const lat=parseFloat(document.getElementById('zoneLat').value);
    const lon=parseFloat(document.getElementById('zoneLon').value);
    const name=document.getElementById('zoneName').value || "–ó–æ–Ω–∞";
    if(!isNaN(lat)&&!isNaN(lon)){ data.zone={lat,lon,name}; saveData(); updateUI(); notify("–ó–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!"); }
}

function setExc(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            data.excavator = { lat: pos.coords.latitude, lon: pos.coords.longitude, name:document.getElementById('excName').value || "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä"};
            saveData();
            updateUI();
            notify("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        });
    } else { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); }
}

function saveExc(){
    const lat=parseFloat(document.getElementById('excLat').value);
    const lon=parseFloat(document.getElementById('excLon').value);
    const name=document.getElementById('excName').value || "–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä";
    if(!isNaN(lat)&&!isNaN(lon)){ data.excavator={lat,lon,name}; saveData(); updateUI(); notify("–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω!"); }
}

function getDistance(lat1, lon1, lat2, lon2){
    const R=6371e3;
    const œÜ1=lat1*Math.PI/180;
    const œÜ2=lat2*Math.PI/180;
    const ŒîœÜ=(lat2-lat1)*Math.PI/180;
    const ŒîŒª=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c; // –≤ –º–µ—Ç—Ä–∞—Ö
}

function startTracking(){
    if(!navigator.geolocation){ alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); return; }
    navigator.geolocation.watchPosition(pos=>{
        positionHistory.push({lat:pos.coords.latitude, lon:pos.coords.longitude, time:new Date()});
        if(positionHistory.length>MAX_HISTORY) positionHistory.shift();
        let sumLat=0, sumLon=0;
        positionHistory.forEach(p=>{sumLat+=p.lat; sumLon+=p.lon;});
        data.currentLat = sumLat/positionHistory.length;
        data.currentLon = sumLon/positionHistory.length;
        updateStatusAndTrip(data.currentLat, data.currentLon);
        updateUI();
    }, err=>{ console.error(err); }, { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
}

function updateStatusAndTrip(lat, lon){
    if(!data.zone || !data.excavator) return;
    const distToExc = getDistance(lat, lon, data.excavator.lat, data.excavator.lon);
    const distToZone = getDistance(lat, lon, data.zone.lat, data.zone.lon);

    if(distToExc < 30){
        if(data.currentStatus !== "–ó–∞–≥—Ä—É–∑–∫–∞"){
            data.currentStatus="–ó–∞–≥—Ä—É–∑–∫–∞";
            startTrip(lat, lon);
        }
        if(distToZone<30) endTrip();
    } else if(distToZone < 30){
        data.currentStatus="–í—ã–≥—Ä—É–∂–∞–µ–º";
        startTripIfNeeded();
    } else{
        if(data.currentStatus==="–ó–∞–≥—Ä—É–∑–∫–∞") data.currentStatus="–í –ø—É—Ç–∏";
        else if(data.currentStatus==="–í—ã–≥—Ä—É–∂–∞–µ–º") data.currentStatus="–ï–¥–µ–º –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É";
    }

    if(data.currentTrip && data.currentTrip.lastLat!==undefined){
        const delta=getDistance(lat, lon, data.currentTrip.lastLat, data.currentTrip.lastLon);
        data.currentTrip.distance += delta;
    }

    if(data.currentTrip){
        data.currentTrip.lastLat=lat;
        data.currentTrip.lastLon=lon;
    }
}

function startTrip(lat, lon){
    if(!data.currentTrip){
        data.currentTrip={startTime:new Date(), distance:0, lastLat:lat, lastLon:lon};
    }
}

function startTripIfNeeded(){
    if(!data.currentTrip){
        data.currentTrip={startTime:new Date(), distance:0, lastLat:data.currentLat, lastLon:data.currentLon};
    }
}

function endTrip(){
    if(data.currentTrip){
        data.currentTrip.endTime=new Date();
        data.tripData.push({...data.currentTrip});
        data.trips++;
        data.currentTrip=null;
    }
}

function formatDuration(ms){
    const totalSec=Math.floor(ms/1000);
    const h=Math.floor(totalSec/3600);
    const m=Math.floor((totalSec%3600)/60);
    const s=totalSec%60;
    return `${h}—á ${m}–º ${s}—Å`;
}

function renderTripList(){
    const list=document.getElementById('tripList');
    list.innerHTML='';
    data.tripData.forEach((t,i)=>{
        const li=document.createElement('li');
        const duration=t.endTime ? formatDuration(new Date(t.endTime)-new Date(t.startTime)) : '-';
        const distance=t.distance ? (t.distance/1000).toFixed(2)+' –∫–º' : "-";
        li.innerText=`–†–µ–π—Å ${i+1}: ${new Date(t.startTime).toLocaleString()} ‚Üí ${t.endTime ? new Date(t.endTime).toLocaleString() : "-"} | –í—Ä–µ–º—è: ${duration} | –î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${distance}`;
        list.appendChild(li);
    });
}

function downloadData(){
    const dataStr=JSON.stringify(data.tripData,null,2);
    const blob=new Blob([dataStr], {type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='trips_data.json'; a.click();
    URL.revokeObjectURL(url);
}

loadData();
startTracking();
</script>

</body>
</html>




