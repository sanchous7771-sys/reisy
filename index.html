<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°—á—ë—Ç—á–∏–∫ —Ä–µ–π—Å–æ–≤</title>
<meta charset="UTF-8">
<style>
body { font-family: Arial; text-align: center; padding: 20px; }
button { padding: 10px 20px; font-size: 16px; margin: 5px; }
input { padding: 5px; font-size: 16px; width: 150px; }
#status { margin-top: 20px; font-size: 18px; }
</style>
</head>
<body>
<h1>üöõ –°—á—ë—Ç—á–∏–∫ —Ä–µ–π—Å–æ–≤</h1>

<div id="setup">
  <p>–ù–∞–∂–º–∏ "–ó–∞–ø–æ–º–Ω–∏—Ç—å —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä" –∏ "–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–±—Ä–∏–∫—É", —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.</p>
  <button onclick="setExcavator()">–ó–∞–ø–æ–º–Ω–∏—Ç—å —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä</button>
  <br>
  <input type="text" id="factoryLat" placeholder="–®–∏—Ä–æ—Ç–∞">
  <input type="text" id="factoryLon" placeholder="–î–æ–ª–≥–æ—Ç–∞">
  <button onclick="addFactory()">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–±—Ä–∏–∫—É</button>
</div>

<div id="main" style="display:none;">
  <p>–ù–∞–∂–º–∏ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–µ–π—Å–æ–≤.</p>
  <button onclick="startTracking()">–°—Ç–∞—Ä—Ç</button>
  <button onclick="exportCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
  <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
  <div>–í—Å–µ–≥–æ —Ä–µ–π—Å–æ–≤: <span id="count">0</span></div>
</div>

<script>
let EXCAVATOR = localStorage.getItem('excavator') ? JSON.parse(localStorage.getItem('excavator')) : null;
let FACTORIES = localStorage.getItem('factories') ? JSON.parse(localStorage.getItem('factories')) : [];
let tripActive = false;
let trips = localStorage.getItem('trips') ? JSON.parse(localStorage.getItem('trips')) : [];
document.getElementById('count').innerText = trips.length;

if (EXCAVATOR && FACTORIES.length > 0) {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('main').style.display = 'block';
}

function haversine(coord1, coord2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    let [lat1, lon1] = coord1;
    let [lat2, lon2] = coord2;
    let dLat = toRad(lat2 - lat1);
    let dLon = toRad(lon2 - lon1);
    let a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
    return 2 * R * Math.asin(Math.sqrt(a));
}

function setExcavator() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            EXCAVATOR = [pos.coords.latitude, pos.coords.longitude];
            localStorage.setItem('excavator', JSON.stringify(EXCAVATOR));
            alert("–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
            if (FACTORIES.length > 0) {
                document.getElementById('setup').style.display = 'none';
                document.getElementById('main').style.display = 'block';
            }
        }, err => { alert("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: " + err.message); }, { enableHighAccuracy: true });
    } else { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); }
}

function addFactory() {
    let lat = parseFloat(document.getElementById('factoryLat').value);
    let lon = parseFloat(document.getElementById('factoryLon').value);
    if (!isNaN(lat) && !isNaN(lon)) {
        FACTORIES.push([lat, lon]);
        localStorage.setItem('factories', JSON.stringify(FACTORIES));
        alert("–§–∞–±—Ä–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
        if (EXCAVATOR) {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('main').style.display = 'block';
        }
    } else {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.");
    }
}

let watchId = null;
function startTracking() {
    document.getElementById('status').innerText = "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ...";
    if (navigator.geolocation) {
        if (watchId !== null) navigator.geolocation.clearWatch(watchId);
        watchId = navigator.geolocation.watchPosition(pos => {
            let lat = pos.coords.latitude;
            let lon = pos.coords.longitude;
            if (!EXCAVATOR || FACTORIES.length === 0) return;
            let distExc = haversine([lat, lon], EXCAVATOR);
            let nearFactory = FACTORIES.some(f => haversine([lat, lon], f) < 50);
            if (!tripActive && distExc < 50) { tripActive = true; document.getElementById('status').innerText = "–†–µ–π—Å –Ω–∞—á–∞–ª—Å—è!"; }
            if (tripActive && nearFactory) {
                tripActive = false;
                trips.push({time: new Date().toISOString()});
                localStorage.setItem('trips', JSON.stringify(trips));
                document.getElementById('count').innerText = trips.length;
                document.getElementById('status').innerText = "–†–µ–π—Å –∑–∞–≤–µ—Ä—à—ë–Ω!";
                setTimeout(() => { document.getElementById('status').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ..."; }, 3000);
            }
        }, err => { document.getElementById('status').innerText = "–û—à–∏–±–∫–∞: " + err.message; }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
    } else { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); }
}

function exportCSV() {
    if (trips.length === 0) { alert("–ù–µ—Ç —Ä–µ–π—Å–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞."); return; }
    let csv = "–í—Ä–µ–º—è —Ä–µ–π—Å–∞
" + trips.map(t => t.time).join("
");
    let blob = new Blob([csv], {type: "text/csv"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "trips.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
</body>
</html>
