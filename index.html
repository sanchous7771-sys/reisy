<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Автоматический учёт рейсов ПГС</title>
<style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    h1 { color: #333; text-align: center; }
    .panel { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; }
    .card { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); flex: 1 1 200px; margin: 10px; }
    .card h3 { margin-top: 0; color: #555; font-size: 16px; }
    .card p { font-size: 18px; margin: 5px 0; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
    .btn { background: #4CAF50; color: white; }
    .btn-red { background: #f44336; color: white; }
    .btn-blue { background: #2196F3; color: white; }
    .settings { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .settings input { margin: 5px; padding: 5px; width: 120px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; }
    th { background: #2196F3; color: white; }
    #notify { padding: 8px; background: #eee; margin-top: 10px; border-radius: 5px; display: none; text-align: center; }
</style>
</head>
<body>
<h1>Автоматический учёт рейсов ПГС</h1>

<div class="panel">
    <div class="card">
        <h3>Зона выгрузки</h3>
        <p id="zoneName">не задано</p>
        <p id="zoneCoords">-</p>
    </div>
    <div class="card">
        <h3>Экскаватор</h3>
        <p id="excName">не задано</p>
        <p id="excCoords">-</p>
    </div>
    <div class="card">
        <h3>Текущие координаты</h3>
        <p id="coords">нет данных</p>
    </div>
    <div class="card">
        <h3>Статус</h3>
        <p id="status">Ожидание...</p>
    </div>
    <div class="card">
        <h3>Счётчик рейсов</h3>
        <p id="counter">0</p>
    </div>
</div>

<div class="settings">
    <button onclick="toggleSettings()">⚙ Настройки зон</button>
    <div id="settingsPanel" style="display:none; margin-top:10px;">
        <h4>Добавить/Сохранить Зону выгрузки</h4>
        <input id="zoneNameInput" placeholder="Название">
        <input id="zoneLatInput" placeholder="Широта">
        <input id="zoneLonInput" placeholder="Долгота">
        <button class="btn" onclick="saveZone()">Сохранить</button>

        <h4>Добавить/Сохранить Экскаватор</h4>
        <input id="excNameInput" placeholder="Название">
        <input id="excLatInput" placeholder="Широта">
        <input id="excLonInput" placeholder="Долгота">
        <button class="btn" onclick="saveExc()">Сохранить</button>
    </div>
</div>

<div id="notify"></div>

<h3>История рейсов</h3>
<table>
    <thead>
        <tr><th>#</th><th>Начало</th><th>Конец</th><th>Время рейса</th><th>Км</th></tr>
    </thead>
    <tbody id="tripTable"></tbody>
</table>

<button class="btn-blue" onclick="downloadData()" style="margin-top:10px;">⬇ Выгрузить историю</button>

<script>
let data = {
    zone: null,
    excavator: null,
    trips: 0,
    tripData: [],
    lastPoint: null,
    enRoute: false,
    currentStatus: 'Ожидание...'
};

function saveData(){ localStorage.setItem('pgsData', JSON.stringify(data)); }
function loadData(){ const saved = localStorage.getItem('pgsData'); if(saved){ data = JSON.parse(saved); updateUI(); } }

function notify(msg){ const n = document.getElementById('notify'); n.innerText=msg; n.style.display='block'; setTimeout(()=>n.style.display='none',3000); }

function updateUI(){
    document.getElementById('counter').innerText=data.trips;
    if(data.zone){ document.getElementById('zoneName').innerText=data.zone.name; document.getElementById('zoneCoords').innerText=`${data.zone.lat.toFixed(6)}, ${data.zone.lon.toFixed(6)}`; }
    if(data.excavator){ document.getElementById('excName').innerText=data.excavator.name; document.getElementById('excCoords').innerText=`${data.excavator.lat.toFixed(6)}, ${data.excavator.lon.toFixed(6)}`; }
    renderTripTable();
}

function renderTripTable(){
    const tbody = document.getElementById('tripTable'); tbody.innerHTML='';
    data.tripData.forEach((t,i)=>{
        const timeSec = (new Date(t.endTime)-new Date(t.startTime))/1000;
        const hours = Math.floor(timeSec/3600);
        const mins = Math.floor((timeSec%3600)/60);
        const secs = Math.floor(timeSec%60);
        const distKm = (t.distance/1000).toFixed(2);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${t.startTime}</td><td>${t.endTime}</td><td>${hours}ч ${mins}м ${secs}с</td><td>${distKm}</td>`;
        tbody.appendChild(tr);
    });
}

function toggleSettings(){
    const p=document.getElementById('settingsPanel');
    p.style.display=p.style.display==='none'?'block':'none';
}

function saveZone(){
    const n=document.getElementById('zoneNameInput').value;
    const lat=parseFloat(document.getElementById('zoneLatInput').value);
    const lon=parseFloat(document.getElementById('zoneLonInput').value);
    if(n && !isNaN(lat) && !isNaN(lon)){ data.zone={name:n,lat,lon}; updateUI(); saveData(); notify("Зона выгрузки сохранена!"); } 
    else notify("Введите корректные данные!");
}

function saveExc(){
    const n=document.getElementById('excNameInput').value;
    const lat=parseFloat(document.getElementById('excLatInput').value);
    const lon=parseFloat(document.getElementById('excLonInput').value);
    if(n && !isNaN(lat) && !isNaN(lon)){ data.excavator={name:n,lat,lon}; updateUI(); saveData(); notify("Экскаватор сохранён!"); } 
    else notify("Введите корректные данные!");
}

function getDistance(lat1, lon1, lat2, lon2){
    const R=6371e3, φ1=lat1*Math.PI/180, φ2=lat2*Math.PI/180, Δφ=(lat2-lat1)*Math.PI/180, Δλ=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function downloadData(){
    const blob=new Blob([JSON.stringify(data.tripData,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='trips_data.json'; a.click(); URL.revokeObjectURL(url);
}

// Отслеживание с фильтрацией и сглаживанием
let lastPositions=[];
const MAX_POSITIONS=5, EXC_RADIUS=30, ZONE_RADIUS=30;

function startTracking(){
    navigator.geolocation.watchPosition(pos=>{
        const {latitude:lat, longitude:lon, accuracy} = pos.coords;
        if(accuracy>15) return;
        lastPositions.push({lat,lon});
        if(lastPositions.length>MAX_POSITIONS) lastPositions.shift();
        const avgLat=lastPositions.reduce((s,p)=>s+p.lat,0)/lastPositions.length;
        const avgLon=lastPositions.reduce((s,p)=>s+p.lon,0)/lastPositions.length;
        document.getElementById('coords').innerText=`${avgLat.toFixed(6)}, ${avgLon.toFixed(6)}`;

        if(!data.zone || !data.excavator){ document.getElementById('status').innerText="Ожидание установки точек..."; return; }

        const distExc=getDistance(avgLat, avgLon, data.excavator.lat, data.excavator.lon);
        const distZone=getDistance(avgLat, avgLon, data.zone.lat, data.zone.lon);

        let newStatus='';
        if(distExc<EXC_RADIUS) newStatus="Загрузка";
        else if(distZone<ZONE_RADIUS) newStatus="Выгружаем";
        else if(data.enRoute) newStatus="В пути";
        else newStatus="Едем на загрузку";

        if(newStatus!==data.currentStatus){
            data.currentStatus=newStatus;
            document.getElementById('status').innerText=newStatus;

            if(newStatus==="Загрузка" && !data.enRoute){
                data.enRoute=true;
                data.lastPoint={lat:avgLat,lon:avgLon,time:new Date().toLocaleString()};
                notify("Начало рейса!");
            }

            if(newStatus==="Выгружаем" && data.enRoute){
                const start = data.lastPoint;
                const end = {lat:avgLat,lon:avgLon,time:new Date().toLocaleString()};
                const distance=getDistance(start.lat,start.lon,end.lat,end.lon);
                data.trips++;
                data.tripData.push({startCoords:start,endCoords:end,startTime:start.time,endTime:end.time,distance});
                data.enRoute=false;
                updateUI();
                saveData();
                notify("Рейс завершён!");
            }
        }
    }, err=>{ notify("Ошибка геолокации: "+err.message); }, {enableHighAccuracy:true, maximumAge:0, timeout:5000});
}

loadData();
updateUI();
startTracking();
</script>
</body>
</html>


