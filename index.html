<script>
const EXC_RADIUS = 20; // радиус экскаватора в метрах
const ZONE_RADIUS = 20; // радиус зоны выгрузки в метрах

let data = {
    zone: null,
    excavator: null,
    trips: 0,
    tripData: [],
    lastPoint: null,
    enRoute: false,
    currentStatus: "Ожидание..."
};

function saveData() { localStorage.setItem('pgsData', JSON.stringify(data)); }
function loadData() {
    const saved = localStorage.getItem('pgsData');
    if(saved) data = JSON.parse(saved);
    updateUI();
}

function notify(msg) {
    const n = document.getElementById('notify');
    n.innerText = msg;
    n.style.display='block';
    setTimeout(()=> n.style.display='none',3000);
}

function updateUI() {
    document.getElementById('counter').innerText = data.trips;
    document.getElementById('status').innerText = data.currentStatus;
    document.getElementById('coords').innerText = "нет данных";
    document.getElementById('zoneCoords').innerText = data.zone ? `${data.zone.lat.toFixed(6)}, ${data.zone.lon.toFixed(6)}` : 'не задано';
    document.getElementById('excCoords').innerText = data.excavator ? `${data.excavator.lat.toFixed(6)}, ${data.excavator.lon.toFixed(6)}` : 'не задано';
    renderTripTable();
}

function renderTripTable() {
    const table = document.getElementById('tripTableBody');
    table.innerHTML='';
    data.tripData.forEach((t,i)=>{
        const start = new Date(t.startTime);
        const end = new Date(t.endTime);
        const diffSec = (end-start)/1000;
        const h = Math.floor(diffSec/3600);
        const m = Math.floor((diffSec%3600)/60);
        const s = Math.floor(diffSec%60);
        const row = `<tr>
            <td>${i+1}</td>
            <td>${start.toLocaleString()}</td>
            <td>${end.toLocaleString()}</td>
            <td>${h} ч ${m} м ${s} с</td>
            <td>${t.distance.toFixed(2)} м</td>
        </tr>`;
        table.innerHTML += row;
    });
}

function setZone() {
    navigator.geolocation.getCurrentPosition(pos=>{
        data.zone={lat: pos.coords.latitude, lon: pos.coords.longitude};
        updateUI(); saveData(); notify("Зона выгрузки сохранена!");
    }, err=>notify("Ошибка получения координат зоны"), {enableHighAccuracy:true});
}

function setExcavator() {
    navigator.geolocation.getCurrentPosition(pos=>{
        data.excavator={lat: pos.coords.latitude, lon: pos.coords.longitude};
        updateUI(); saveData(); notify("Экскаватор сохранён!");
    }, err=>notify("Ошибка получения координат экскаватора"), {enableHighAccuracy:true});
}

function getDistance(lat1,lon1,lat2,lon2){
    const R=6371000;
    const φ1=lat1*Math.PI/180;
    const φ2=lat2*Math.PI/180;
    const Δφ=(lat2-lat1)*Math.PI/180;
    const Δλ=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
}

function startTracking() {
    navigator.geolocation.watchPosition(pos=>{
        const lat=pos.coords.latitude;
        const lon=pos.coords.longitude;
        document.getElementById('coords').innerText=`${lat.toFixed(6)}, ${lon.toFixed(6)}`;

        if(!data.zone || !data.excavator) { data.currentStatus="Ожидание установки точек..."; document.getElementById('status').innerText=data.currentStatus; return; }

        const distExc=getDistance(lat,lon,data.excavator.lat,data.excavator.lon);
        const distZone=getDistance(lat,lon,data.zone.lat,data.zone.lon);
        let newStatus='';

        if(distExc<EXC_RADIUS) newStatus="Загрузка";
        else if(distZone<ZONE_RADIUS) newStatus="Выгружаем";
        else if(data.enRoute) newStatus="В пути";
        else newStatus="Едем на загрузку";

        if(newStatus!==data.currentStatus){
            data.currentStatus=newStatus;
            document.getElementById('status').innerText=newStatus;

            if(newStatus==="Загрузка" && !data.enRoute){
                data.enRoute=true;
                data.lastPoint={lat,lon,time:new Date().toISOString()};
                notify("Начало рейса!");
            }

            if(newStatus==="Выгружаем" && data.enRoute){
                const start = data.lastPoint;
                const end = {lat,lon,time:new Date().toISOString()};
                const distance = getDistance(start.lat,start.lon,end.lat,end.lon);
                data.trips++;
                data.tripData.push({startCoords:start,endCoords:end,startTime:start.time,endTime:end.time,distance});
                data.enRoute=false;
                updateUI(); saveData(); notify("Рейс завершён!");
            }
        }

    }, err=>notify("Ошибка геолокации: "+err.message), {enableHighAccuracy:true, maximumAge:0, timeout:5000});
}

loadData();
updateUI();
startTracking();
</script>



