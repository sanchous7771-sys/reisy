<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
    .btn { background: #4CAF50; color: white; }
    .btn-red { background: #f44336; color: white; }
    .btn-blue { background: #2196F3; color: white; }
    #coords { font-size: 14px; color: #555; }
    #notify { padding: 8px; background: #eee; margin-top: 10px; border-radius: 5px; display: none; }
    ul { padding-left: 20px; }
</style>
</head>
<body>
<h1>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</h1>

<p>–§–∞–±—Ä–∏–∫–∞: <span id="fabCoords">–Ω–µ –∑–∞–¥–∞–Ω–æ</span></p>
<p>–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä: <span id="excCoords">–Ω–µ –∑–∞–¥–∞–Ω–æ</span></p>
<p>–¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span id="coords">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></p>
<p>–°—Ç–∞—Ç—É—Å: <span id="status">–û–∂–∏–¥–∞–Ω–∏–µ...</span></p>
<p>–°—á—ë—Ç—á–∏–∫ —Ä–µ–π—Å–æ–≤: <span id="counter">0</span></p>

<button class="btn" onclick="setFactory()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–±—Ä–∏–∫—É</button>
<button class="btn" onclick="setExcavator()">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä</button>
<button class="btn-red" onclick="resetData()">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
<button class="btn-blue" onclick="downloadData()">‚¨áÔ∏è –í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>

<div id="notify"></div>

<h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–π—Å–æ–≤:</h3>
<ul id="tripList"></ul>

<script>
let data = {
    factory: null,
    excavator: null,
    trips: 0,
    tripData: [],
    lastPoint: null,
    enRoute: false
};

function saveData() {
    localStorage.setItem('pgsData', JSON.stringify(data));
}
function loadData() {
    const saved = localStorage.getItem('pgsData');
    if (saved) {
        data = JSON.parse(saved);
        updateUI();
    }
}

function notify(msg) {
    const n = document.getElementById('notify');
    n.innerText = msg;
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 3000);
}

function updateUI() {
    document.getElementById('counter').innerText = data.trips;
    if (data.factory) {
        document.getElementById('fabCoords').innerText = `${data.factory.lat.toFixed(6)}, ${data.factory.lon.toFixed(6)}`;
    }
    if (data.excavator) {
        document.getElementById('excCoords').innerText = `${data.excavator.lat.toFixed(6)}, ${data.excavator.lon.toFixed(6)}`;
    }
    renderTripList();
}

function renderTripList() {
    const list = document.getElementById('tripList');
    list.innerHTML = '';
    data.tripData.forEach((t, i) => {
        const li = document.createElement('li');
        li.innerText = `–†–µ–π—Å ${i+1}: ${t.startTime} ‚Üí ${t.endTime}`;
        list.appendChild(li);
    });
}

function setFactory() {
    navigator.geolocation.getCurrentPosition(pos => {
        data.factory = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        updateUI();
        saveData();
        notify("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ñ–∞–±—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    }, err => {
        notify("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ñ–∞–±—Ä–∏–∫–∏");
    }, { enableHighAccuracy: true });
}

function setExcavator() {
    navigator.geolocation.getCurrentPosition(pos => {
        data.excavator = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        updateUI();
        saveData();
        notify("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    }, err => {
        notify("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞");
    }, { enableHighAccuracy: true });
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(ŒîœÜ/2)**2 +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function resetData() {
    if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
        data = { factory: null, excavator: null, trips: 0, tripData: [], lastPoint: null, enRoute: false };
        updateUI();
        saveData();
        notify("–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã!");
    }
}

function downloadData() {
    const dataStr = JSON.stringify(data.tripData, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trips_data.json';
    a.click();
    URL.revokeObjectURL(url);
}

function startTracking() {
    navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        document.getElementById('coords').innerText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

        if (!data.factory || !data.excavator) {
            document.getElementById('status').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ—á–µ–∫...";
            return;
        }

        const distToExcavator = getDistance(lat, lon, data.excavator.lat, data.excavator.lon);
        const distToFactory = getDistance(lat, lon, data.factory.lat, data.factory.lon);

        if (distToExcavator < 30) {
            document.getElementById('status').innerText = "–£ —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞";
            if (!data.enRoute) {
                data.enRoute = true;
                data.lastPoint = { lat, lon, time: new Date().toLocaleString() };
                notify("–ù–∞—á–∞–ª–æ —Ä–µ–π—Å–∞!");
            }
        }

        if (distToFactory < 30 && data.enRoute) {
            document.getElementById('status').innerText = "–ù–∞ —Ñ–∞–±—Ä–∏–∫–µ";
            data.trips++;
            data.tripData.push({
                startTime: data.lastPoint.time,
                endTime: new Date().toLocaleString()
            });
            data.enRoute = false;
            updateUI();
            saveData();
            notify("–†–µ–π—Å –∑–∞–≤–µ—Ä—à—ë–Ω!");
        }

    }, err => {
        notify("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: " + err.message);
    }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 });
}

// –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
navigator.geolocation.getCurrentPosition(pos => {
    notify("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞!");
    startTracking();
}, err => {
    notify("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã");
}, { enableHighAccuracy: true });

loadData();
</script>
</body>
</html>
