<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–£—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
h1 { text-align: center; color: #333; margin-bottom: 20px; }
.panel { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
.panel div { background: #fff; padding: 15px; border-radius: 12px; flex: 1 1 200px; min-width: 180px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
.panel div span { display: block; margin-top: 5px; font-weight: bold; }
button { padding: 10px 15px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; }
.btn { background: #4CAF50; color: white; }
.btn-red { background: #f44336; color: white; }
.btn-blue { background: #2196F3; color: white; }
.form-group { display: none; margin-top: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
.form-group input, .form-group select { padding: 5px; margin-right: 5px; border-radius: 4px; border: 1px solid #ccc; }
table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
th { background: #2196F3; color: white; }
#notify { padding: 8px; margin-top: 10px; border-radius: 5px; display: none; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
.point-list { margin-top: 10px; }
.point-item { background: #e3f2fd; margin-bottom: 5px; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
.point-item span { flex: 1; }
.point-actions button { margin-left: 5px; }
</style>
</head>
<body>

<h1>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</h1>

<div class="panel">
    <div id="currentCoords">–¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span>–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>
    <div id="status">–°—Ç–∞—Ç—É—Å: <span>–û–∂–∏–¥–∞–Ω–∏–µ...</span></div>
    <div>–°—á—ë—Ç—á–∏–∫ —Ä–µ–π—Å–æ–≤: <span id="counter">0</span></div>
    <div>–û–±—â–∏–π –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂: <span id="kmTotal">0</span> –∫–º</div>
</div>

<button class="btn" onclick="toggleForm()">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ—á–µ–∫</button>

<div class="form-group" id="zoneForm">
    <h3>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</h3>
    <div>
        <input type="text" id="pointName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏">
        <input type="number" id="pointLat" placeholder="–®–∏—Ä–æ—Ç–∞">
        <input type="number" id="pointLon" placeholder="–î–æ–ª–≥–æ—Ç–∞">
        <select id="pointType">
            <option value="unload">–ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏</option>
            <option value="exc">–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä</option>
        </select>
        <button class="btn" onclick="savePoint()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="point-list" id="pointList"></div>
</div>

<div id="notify"></div>

<table>
    <thead>
        <tr>
            <th>‚Ññ —Ä–µ–π—Å–∞</th>
            <th>–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏</th>
            <th>–í—Ä–µ–º—è –≤—ã–≥—Ä—É–∑–∫–∏</th>
            <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
            <th>–ö–º</th>
        </tr>
    </thead>
    <tbody id="tripTable"></tbody>
</table>

<button class="btn-blue" onclick="downloadData()">‚¨áÔ∏è –í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
<button class="btn-red" onclick="resetDay()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π —Å—á—ë—Ç—á–∏–∫ –∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂</button>

<script>
let data = {
    points: [],
    trips: 0,
    tripData: [],
    kmTotal: 0,
    lastPoint: null,
    enRoute: false,
    unloadZone: null,
    excZone: null
};

function notify(msg){const n=document.getElementById('notify');n.innerText=msg;n.style.display='block';setTimeout(()=>n.style.display='none',3000);}

function saveData(){localStorage.setItem('pgsData',JSON.stringify(data));}
function loadData(){const s=localStorage.getItem('pgsData');if(s){data=JSON.parse(s);} updateUI(); renderPointList();}

function toggleForm(){const f=document.getElementById('zoneForm'); f.style.display=f.style.display==='none'?'block':'none';}

function updateUI(){
    document.getElementById('counter').innerText=data.trips;
    document.getElementById('kmTotal').innerText=data.kmTotal.toFixed(2);
    renderTripTable();
}

function renderTripTable(){
    const tbody=document.getElementById('tripTable'); tbody.innerHTML='';
    data.tripData.forEach((t,i)=>{
        let dur='‚Äî';
        if(t.loadTime && t.unloadTime){
            const d=(t.unloadTime-t.loadTime)/1000;
            const h=Math.floor(d/3600), m=Math.floor((d%3600)/60), s=Math.floor(d%60);
            dur=`${h}—á ${m}–º ${s}—Å`;
        }
        tbody.innerHTML+=`<tr>
            <td>${i+1}</td>
            <td>${t.loadTime?new Date(t.loadTime).toLocaleTimeString():'‚Äî'}</td>
            <td>${t.unloadTime?new Date(t.unloadTime).toLocaleTimeString():'‚Äî'}</td>
            <td>${dur}</td>
            <td>${t.km?t.km.toFixed(2):0}</td>
        </tr>`;
    });
}

// ---------- —Ç–æ—á–∫–∏ ----------
function savePoint(editIndex=null){
    const name=document.getElementById('pointName').value;
    const lat=parseFloat(document.getElementById('pointLat').value);
    const lon=parseFloat(document.getElementById('pointLon').value);
    const type=document.getElementById('pointType').value;
    if(!name||isNaN(lat)||isNaN(lon)){notify('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'); return;}
    if(editIndex!==null){data.points[editIndex]={name,lat,lon,type}; notify('–¢–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');}
    else {data.points.push({name,lat,lon,type}); notify('–¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');}
    renderPointList();
    saveData();
}

function renderPointList(){
    const list=document.getElementById('pointList'); list.innerHTML='';
    data.points.forEach((p,i)=>{
        const div=document.createElement('div'); div.className='point-item';
        div.innerHTML=`<span>${p.name} (${p.lat.toFixed(6)},${p.lon.toFixed(6)}) [${p.type==='unload'?'–ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏':'–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä'}]</span>
        <div class="point-actions">
            <button class="btn" onclick="assignPoint(${i})">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
            <button class="btn" onclick="editPoint(${i})">‚úèÔ∏è</button>
            <button class="btn-red" onclick="deletePoint(${i})">‚ùå</button>
        </div>`;
        list.appendChild(div);
    });
}

function editPoint(index){
    const p=data.points[index];
    document.getElementById('pointName').value=p.name;
    document.getElementById('pointLat').value=p.lat;
    document.getElementById('pointLon').value=p.lon;
    document.getElementById('pointType').value=p.type;
    // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    document.getElementById('zoneForm').dataset.edit=index;
}

function deletePoint(index){if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É?')){data.points.splice(index,1); renderPointList(); saveData(); notify('–¢–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞');}}

function assignPoint(index){
    const p=data.points[index];
    if(p.type==='unload'){data.unloadZone=p; notify(`–ù–∞–∑–Ω–∞—á–µ–Ω–∞ –∑–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏: ${p.name}`);}
    else{data.excZone=p; notify(`–ù–∞–∑–Ω–∞—á–µ–Ω —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä: ${p.name}`);}
    saveData();
}

// ---------- –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ----------
function updateCoords(lat,lon){
    document.getElementById('currentCoords').querySelector('span').innerText=`${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    if(!data.excZone || !data.unloadZone) return;
    const distExc=getDistance(lat,lon,data.excZone.lat,data.excZone.lon);
    const distUnload=getDistance(lat,lon,data.unloadZone.lat,data.unloadZone.lon);
    const statusElem=document.getElementById('status').querySelector('span');
    const THRESH=0.03;
    if(distExc<THRESH){
        statusElem.innerText='–£ —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞';
        if(!data.enRoute){data.enRoute=true; data.lastPoint={lat,lon,time:Date.now()}; data.tripData.push({loadTime:Date.now(),unloadTime:null,km:0}); saveData();}
    } else if(distUnload<THRESH){
        statusElem.innerText='–í—ã–≥—Ä—É–∂–∞–µ–º';
        if(data.enRoute){
            const t=data.tripData[data.tripData.length-1];
            t.unloadTime=Date.now();
            t.km+=getDistance(lat,lon,data.lastPoint.lat,data.lastPoint.lon);
            data.kmTotal+=t.km; data.trips++; data.enRoute=false; saveData(); updateUI();
        }
    } else if(data.enRoute){statusElem.innerText='–í –ø—É—Ç–∏ –Ω–∞ –≤—ã–≥—Ä—É–∑–∫—É';}
    else{statusElem.innerText='–ï–¥–µ–º –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É';}
    data.lastPoint={lat,lon,time:Date.now()};
}

function getDistance(lat1,lon1,lat2,lon2){
    const R=6371e3; const œÜ1=lat1*Math.PI/180, œÜ2=lat2*Math.PI/180;
    const ŒîœÜ=(lat2-lat1)*Math.PI/180, ŒîŒª=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return (R*c)/1000;
}

function startTracking(){
    if(!navigator.geolocation){notify('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return;}
    navigator.geolocation.watchPosition(pos=>{
        updateCoords(pos.coords.latitude,pos.coords.longitude);
    },err=>{console.error(err); notify('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏');},{enableHighAccuracy:true,maximumAge:0,timeout:5000});
}

// ---------- —ç–∫—Å–ø–æ—Ä—Ç –∏ —Å–±—Ä–æ—Å ----------
function downloadData(){
    const csv = ['‚Ññ —Ä–µ–π—Å–∞,–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏,–í—Ä–µ–º—è –≤—ã–≥—Ä—É–∑–∫–∏,–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å,–ö–º'];
    data.tripData.forEach((t,i)=>{
        let dur='‚Äî';
        if(t.loadTime && t.unloadTime){
            const d=(t.unloadTime-t.loadTime)/1000;
            const h=Math.floor(d/3600), m=Math.floor((d%3600)/60), s=Math.floor(d%60);
            dur=`${h}—á ${m}–º ${s}—Å`;
        }
        csv.push([i+1,
                  t.loadTime?new Date(t.loadTime).toLocaleTimeString():'‚Äî',
                  t.unloadTime?new Date(t.unloadTime).toLocaleTimeString():'‚Äî',
                  dur,
                  t.km?t.km.toFixed(2):0].join(','));
    });
    const blob = new Blob([csv.join('\n')], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='trip_history.csv'; a.click();
    URL.revokeObjectURL(url);
}

function resetDay(){if(confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–π—Å—ã –∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂?')){data.trips=0; data.kmTotal=0; data.tripData=[]; saveData(); updateUI(); notify('–°–±—Ä–æ—à–µ–Ω–æ');}}

loadData(); startTracking();
</script>

</body>
</html>















