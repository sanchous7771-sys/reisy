<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–£—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
    h1 { color: #333; margin-bottom: 20px; text-align: center; }
    .panel { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .panel div { background: linear-gradient(135deg,#ffffff,#e3f2fd); padding: 15px; border-radius: 12px; flex: 1 1 200px; min-width: 180px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .panel div:hover { transform: translateY(-3px); }
    .panel div span { font-weight: bold; display: block; margin-top: 5px; font-size: 1.1em; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
    button:hover { transform: scale(1.05); box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
    .btn { background: #4CAF50; color: white; }
    .btn-red { background: #f44336; color: white; }
    .btn-blue { background: #2196F3; color: white; }
    .form-group { display: none; margin-top: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .form-group input { padding: 5px; margin-right: 5px; border-radius: 4px; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #2196F3; color: white; }
    #notify { padding: 8px; margin-top: 10px; border-radius: 5px; display: none; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
</style>
</head>
<body>

<h1>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç —Ä–µ–π—Å–æ–≤ –ü–ì–°</h1>

<div class="panel">
    <div>–ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏: <span id="unloadZone">–Ω–µ –∑–∞–¥–∞–Ω–æ</span></div>
    <div>–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä: <span id="excZone">–Ω–µ –∑–∞–¥–∞–Ω–æ</span></div>
    <div>–¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span id="coords" style="cursor:pointer; text-decoration:underline;">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>
    <div>–°—Ç–∞—Ç—É—Å: <span id="status">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div>
    <div>–°—á—ë—Ç—á–∏–∫ —Ä–µ–π—Å–æ–≤: <span id="counter">0</span></div>
    <div>–û–±—â–∏–π –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂: <span id="kmTotal">0</span> –∫–º</div>
</div>

<button class="btn" onclick="toggleForm()">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–æ–Ω</button>

<div class="form-group" id="zoneForm">
    <input type="text" id="zoneName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏">
    <input type="number" id="zoneLat" placeholder="–®–∏—Ä–æ—Ç–∞">
    <input type="number" id="zoneLon" placeholder="–î–æ–ª–≥–æ—Ç–∞">
    <button class="btn" onclick="saveZone()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ—á–∫—É</button>
    <br><br>
    <label>–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫:</label>
    <select id="savedZonesSelect"></select>
    <button class="btn" onclick="applySavedZone('unload')">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–æ–Ω—É –≤—ã–≥—Ä—É–∑–∫–∏</button>
    <button class="btn" onclick="applySavedZone('exc')">üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä</button>
</div>

<div id="notify"></div>

<table>
    <thead>
        <tr>
            <th>‚Ññ —Ä–µ–π—Å–∞</th>
            <th>–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏</th>
            <th>–í—Ä–µ–º—è –≤—ã–≥—Ä—É–∑–∫–∏</th>
            <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
            <th>–ö–º</th>
        </tr>
    </thead>
    <tbody id="tripTable"></tbody>
</table>

<button class="btn-blue" onclick="downloadData()">‚¨áÔ∏è –í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
<button class="btn-red" onclick="resetDay()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π —Å—á—ë—Ç—á–∏–∫ –∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂</button>

<script>
let data = {
    unloadZone: null,
    excZone: null,
    trips: 0,
    tripData: [],
    kmTotal: 0,
    lastPoint: null,
    enRoute: false
};

let savedZones = [
    {name: "—É–≥–æ–ª –≤–æ–∑–ª–µ –ø–æ–¥—ä–µ–º–∞", lat: 56.081522, lon: 93.201198}
];

let currentLat = null, currentLon = null;

function saveData(){localStorage.setItem('pgsData',JSON.stringify(data));}
function loadData(){const s=localStorage.getItem('pgsData');if(s){data=JSON.parse(s);updateUI();}}

function notify(msg){const n=document.getElementById('notify');n.innerText=msg;n.style.display='block';setTimeout(()=>n.style.display='none',3000);}

function toggleForm(){const f=document.getElementById('zoneForm');f.style.display=f.style.display==='none'?'block':'none';}

function updateUI(){
    document.getElementById('counter').innerText=data.trips;
    document.getElementById('kmTotal').innerText=data.kmTotal.toFixed(2);
    document.getElementById('unloadZone').innerText=data.unloadZone?`${data.unloadZone.name} (${data.unloadZone.lat.toFixed(6)}, ${data.unloadZone.lon.toFixed(6)})`:'–Ω–µ –∑–∞–¥–∞–Ω–æ';
    document.getElementById('excZone').innerText=data.excZone?`${data.excZone.name} (${data.excZone.lat.toFixed(6)}, ${data.excZone.lon.toFixed(6)})`:'–Ω–µ –∑–∞–¥–∞–Ω–æ';
    renderTripTable();
}

function renderTripTable(){
    const tbody=document.getElementById('tripTable');
    tbody.innerHTML='';
    data.tripData.forEach((t,i)=>{
        let dur='‚Äî';
        if(t.loadTime && t.unloadTime){
            const d=(t.unloadTime-t.loadTime)/1000;
            const h=Math.floor(d/3600), m=Math.floor((d%3600)/60), s=Math.floor(d%60);
            dur=`${h}—á ${m}–º ${s}—Å`;
        }
        tbody.innerHTML+=`<tr>
            <td>${i+1}</td>
            <td>${t.loadTime?new Date(t.loadTime).toLocaleTimeString():'‚Äî'}</td>
            <td>${t.unloadTime?new Date(t.unloadTime).toLocaleTimeString():'‚Äî'}</td>
            <td>${dur}</td>
            <td>${t.km?t.km.toFixed(2):0}</td>
        </tr>`;
    });
}

function updateSavedZonesSelect() {
    const sel = document.getElementById('savedZonesSelect');
    sel.innerHTML = '';
    savedZones.forEach((z, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.innerText = `${z.name} (${z.lat.toFixed(6)}, ${z.lon.toFixed(6)})`;
        sel.appendChild(opt);
    });
}

function saveZone() {
    const name = document.getElementById('zoneName').value;
    const lat = parseFloat(document.getElementById('zoneLat').value);
    const lon = parseFloat(document.getElementById('zoneLon').value);
    if (!name || isNaN(lat) || isNaN(lon)) { notify('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!'); return; }
    savedZones.push({name, lat, lon});
    updateSavedZonesSelect();
    notify(`–¢–æ—á–∫–∞ "${name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`);
}

function applySavedZone(type) {
    const sel = document.getElementById('savedZonesSelect');
    const z = savedZones[sel.value];
    if (!z) return;
    if (type === 'unload') { data.unloadZone = {lat: z.lat, lon: z.lon, name: z.name}; notify('–ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'); }
    else { data.excZone = {lat: z.lat, lon: z.lon, name: z.name}; notify('–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'); }
    saveData();
    updateUI();
}

function getDistance(lat1,lon1,lat2,lon2){
    const R=6371e3; const œÜ1=lat1*Math.PI/180, œÜ2=lat2*Math.PI/180;
    const ŒîœÜ=(lat2-lat1)*Math.PI/180, ŒîŒª=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return (R*c)/1000;
}
const THRESH=0.03;

function startTracking(){
    navigator.geolocation.watchPosition(pos=>{
        currentLat = pos.coords.latitude;
        currentLon = pos.coords.longitude;
        document.getElementById('coords').innerText=`${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
        if(!data.unloadZone||!data.excZone){document.getElementById('status').innerText='–û–∂–∏–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–æ–Ω...'; return;}

        const distExc=getDistance(currentLat,currentLon,data.excZone.lat,data.excZone.lon);
        const distUnload=getDistance(currentLat,currentLon,data.unloadZone.lat,data.unloadZone.lon);
        const statusElem=document.getElementById('status');

        if(distExc<THRESH){
            statusElem.innerText='–£ —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞'; statusElem.style.color='green';
            if(!data.enRoute){data.enRoute=true; data.lastPoint={lat:currentLat,lon:currentLon,time:Date.now()}; data.tripData.push({loadTime:Date.now(),unloadTime:null,km:0}); saveData();}
        }
        else if(distUnload<THRESH){
            statusElem.innerText='–í—ã–≥—Ä—É–∂–∞–µ–º'; statusElem.style.color='red';
            if(data.enRoute){
                const t=data.tripData[data.tripData.length-1];
                t.unloadTime=Date.now();
                t.km+=getDistance(currentLat,currentLon,data.lastPoint.lat,data.lastPoint.lon);
                data.kmTotal+=t.km;
                data.trips++; data.enRoute=false; saveData(); updateUI();
            }
        }
        else if(data.enRoute){statusElem.innerText='–í –ø—É—Ç–∏ –Ω–∞ –≤—ã–≥—Ä—É–∑–∫—É'; statusElem.style.color='orange';}
        else{statusElem.innerText='–ï–¥–µ–º –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É'; statusElem.style.color='gray';}

    },err=>console.log(err),{enableHighAccuracy:true, maximumAge:1000});
}

function resetDay(){
    if(confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Ä–µ–π—Å–æ–≤ –∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂ –∑–∞ –¥–µ–Ω—å?')){
        data.trips=0; data.kmTotal=0;
        saveData();
        updateUI();
        notify('–î–Ω–µ–≤–Ω–æ–π —Å—á—ë—Ç—á–∏–∫ –∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂ —Å–±—Ä–æ—à–µ–Ω—ã!');
    }
}

function downloadData(){
    const blob=new Blob([JSON.stringify(data.tripData,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='trip_history.json'; a.click();
    URL.revokeObjectURL(url);
}

// –ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: –∫–ª–∏–∫ –ø–æ —Ç–µ–∫—É—â–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
document.getElementById('coords').addEventListener('click', () => {
    if (!currentLat || !currentLon) {
        notify('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã');
        return;
    }
    if (confirm('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–∫ —Ç–æ—á–∫—É —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞?')) {
        data.excZone = {lat: currentLat, lon: currentLon, name: '–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä'};
        notify('–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    } else if (confirm('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–∫ —Ç–æ—á–∫—É –≤—ã–≥—Ä—É–∑–∫–∏?')) {
        data.unloadZone = {lat: currentLat, lon: currentLon, name: '–í—ã–≥—Ä—É–∑–∫–∞'};
        notify('–ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    }
    saveData();
    updateUI();
});

loadData();
updateSavedZonesSelect();
startTracking();
</script>

</body>
</html>


















